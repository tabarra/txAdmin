{{include("header")/}}


<div class="text-center mb-4">
    <h2>Settings</h2>
</div>


<div class="row justify-content-md-center">
    <div class="col-md-7">

        <!-- Global Card -->
        <div class="card card-accent-danger">
            <!-- <div class="card-header font-weight-bold">Global:</div> -->
            <div class="card-header font-weight-bold">
                <ul class="nav nav-tabs card-header-tabs">
                    <li class="nav-item">
                        <a class="nav-item nav-link active" id="nav-global-tab" data-toggle="tab" href="#nav-global"
                            role="tab" aria-controls="nav-global" aria-selected="true">Global</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-item nav-link " id="nav-fxserver-tab" data-toggle="tab" href="#nav-fxserver"
                            role="tab" aria-controls="nav-fxserver" aria-selected="true">FXServer</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-item nav-link " id="nav-monitor-tab" data-toggle="tab" href="#nav-monitor"
                            role="tab" aria-controls="nav-monitor" aria-selected="true">Monitor/Restarter</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-item nav-link " id="nav-discord-tab" data-toggle="tab" href="#nav-discord"
                            role="tab" aria-controls="nav-discord" aria-selected="true">Discord</a>
                    </li>
                </ul>
            </div>

            <div class="card-body settings-card">
                <div class="tab-content" id="nav-tabContent">
                    <div class="tab-pane fade show active" id="nav-global" role="tabpanel"
                        aria-labelledby="nav-global-tab">

                        <!-- Global Card -->
                        <div class="form-group row">
                            <label for="frmGlobal-serverName" class="col-sm-3 col-form-label">
                                Server Name
                                <span class="text-danger">*</span>
                            </label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" id="frmGlobal-serverName"
                                    value="{{global.serverName}}" maxlength="24" {{disableWrite}}>
                                <span class="form-text text-muted">
                                    A <strong>short</strong> server name to be used in txAdmin interface and Chat/Discord messages.
                                </span>
                            </div>
                        </div>

                        <div class="form-group row">
                            <label for="frmGlobal-publicIP" class="col-sm-3 col-form-label">
                                Public IP
                                <span class="text-danger">*</span>
                            </label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" id="frmGlobal-publicIP"
                                    value="{{global.publicIP}}" maxlength="32" placeholder="123.123.123.123" {{disableWrite}}>
                                    <span class="form-text text-muted">
                                        You can set this to be your public IP or a domain name. <br>
                                        This will only be used for discord messages.
                                    </span>
                            </div>
                        </div>

                        <div class="form-group row">
                            <label for="frmGlobal-language" class="col-sm-3 col-form-label">
                                Language
                            </label>
                            <div class="col-sm-9">
                                <select class="form-control" id="frmGlobal-language" {{disableWrite}}>
                                    <!-- TODO: make this list dynamic -->
                                    <option value="cs" {{global.language=='cs'|isSelected}}>Czech</option>
                                    <option value="da" {{global.language=='da'|isSelected}}>Danish</option>
                                    <option value="de" {{global.language=='de'|isSelected}}>German</option>
                                    <option value="en" {{global.language=='en'|isSelected}}>English</option>
                                    <option value="es" {{global.language=='es'|isSelected}}>Spanish</option>
                                    <option value="fi" {{global.language=='fi'|isSelected}}>Finnish</option>
                                    <option value="fr" {{global.language=='fr'|isSelected}}>French</option>
                                    <option value="hu" {{global.language=='hu'|isSelected}}>Hungarian</option>
                                    <option value="lv" {{global.language=='lv'|isSelected}}>Latvian</option>
                                    <option value="nl" {{global.language=='nl'|isSelected}}>Dutch</option>
                                    <option value="pl" {{global.language=='pl'|isSelected}}>Polish</option>
                                    <option value="pt_BR" {{global.language=='pt_BR'|isSelected}}>Portuguese (Brazil)</option>
                                    <option value="ro" {{global.language=='ro'|isSelected}}>Romanian</option>
                                    <option value="th" {{global.language=='th'|isSelected}}>Thai</option>
                                    <option value="tr" {{global.language=='tr'|isSelected}}>Turkish</option>
                                    <option value="zh" {{global.language=='zh'|isSelected}}>Chinese</option>

                                    <option value="custom" {{global.language=='custom'|isSelected}}>Custom (read the documentation)</option>
                                </select>
                                <span class="form-text text-muted">
                                    The language to use on Chat/Discord messages. <br>
                                    <b>Note:</b> For the Custom option, read the documentation.
                                </span>
                            </div>
                        </div>

                        <div class="form-group row">
                            <label for="frmGlobal-verbose" class="col-sm-3 col-form-label">Verbose</label>
                            <div class="col-sm-9">
                                <label class="switch switch-label switch-pill switch-success fix-pill-form">
                                    <input class="switch-input" type="checkbox" id="frmGlobal-verbose"
                                        {{global.verbose}} {{disableWrite}}>
                                    <span class="switch-slider" data-checked="On" data-unchecked="Off"></span>
                                </label>
                                <span class="form-text text-muted">
                                    By enabling verbosity you will see more detailed information in the terminal. <br>
                                    <b>Note:</b> Do not enable this unless you are troubleshooting errors.
                                </span>
                            </div>
                        </div>

                        <div class="text-center mt-4">
                            <button class="btn btn-sm btn-primary" type="submit" id="frmGlobal-save" {{disableWrite}}>
                                <i class="icons cui-check"></i> Save Global Settings
                            </button>
                        </div>
                        <!-- /Global Card -->

                    </div>
                    <div class="tab-pane fade" id="nav-fxserver" role="tabpanel" aria-labelledby="nav-fxserver-tab">

                        <!-- FXServer Card -->
                        <div class="form-group row">
                            <label for="frmFXServer-buildPath" class="col-sm-3 col-form-label">Build Path
                                <span class="text-danger">*</span></label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" id="frmFXServer-buildPath" value="{{fxserver.buildPath}}"
                                    placeholder="C:/Users/Admin/Documents/fxserver_builds/1380" {{disableWrite}}>
                                <span class="form-text text-muted">
                                    The folder <strong>containing</strong> the files <code>run.cmd</code>, <code>fxserver.exe</code> and
                                    a bunch of DLLs in case of Windows, and only <code>run.sh</code> in case of Linux.
                                </span>
                            </div>
                        </div>

                        <div class="form-group row">
                            <label for="frmFXServer-basePath" class="col-sm-3 col-form-label">Base Path
                                <span class="text-danger">*</span></label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" id="frmFXServer-basePath" value="{{fxserver.basePath}}"
                                    placeholder="C:/Users/Admin/Desktop/server01" {{disableWrite}}>
                                <span class="form-text text-muted">
                                    The folder that <strong>contains</strong> the <code>resources</code> and
                                    <code>cache</code> folders, usually it's here that you put your
                                    <code>server.cfg</code>.
                                </span>
                            </div>
                        </div>

                        <div class="form-group row">
                            <label for="frmFXServer-cfgPath" class="col-sm-3 col-form-label">CFG Path
                                <span class="text-danger">*</span></label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" id="frmFXServer-cfgPath" value="{{fxserver.cfgPath}}"
                                    placeholder="C:/Users/Admin/Desktop/server01/server.cfg" {{disableWrite}}>
                                <span class="form-text text-muted">
                                    The absolute or relative (to the Base) path of your <code>server.cfg</code>.
                                </span>
                            </div>
                        </div>

                        <div class="form-group row">
                            <label for="frmFXServer-onesync" class="col-sm-3 col-form-label">OneSync</label>
                            <div class="col-sm-9">
                                <label class="switch switch-label switch-pill switch-success fix-pill-form">
                                    <input class="switch-input" type="checkbox" id="frmFXServer-onesync"
                                        {{fxserver.onesync}} {{disableWrite}}>
                                    <span class="switch-slider" data-checked="On" data-unchecked="Off"></span>
                                </label>
                                <span class="form-text text-muted">
                                    Required if you server has more than 32 slots.
                                </span>
                            </div>
                        </div>

                        <div class="form-group row">
                            <label for="frmFXServer-autostart" class="col-sm-3 col-form-label">Autostart</label>
                            <div class="col-sm-9">
                                <label class="switch switch-label switch-pill switch-success fix-pill-form">
                                    <input class="switch-input" type="checkbox" id="frmFXServer-autostart"
                                        {{fxserver.autostart}} {{disableWrite}}>
                                    <span class="switch-slider" data-checked="On" data-unchecked="Off"></span>
                                </label>
                                <span class="form-text text-muted">
                                    Start the server automatically after <strong>txAdmin</strong> starts.
                                </span>
                            </div>
                        </div>

                        <div class="form-group row">
                            <label for="frmFXServer-quiet" class="col-sm-3 col-form-label">Quiet</label>
                            <div class="col-sm-9">
                                <label class="switch switch-label switch-pill switch-success fix-pill-form">
                                    <input class="switch-input" type="checkbox" id="frmFXServer-quiet"
                                        {{fxserver.quiet}} {{disableWrite}}>
                                    <span class="switch-slider" data-checked="On" data-unchecked="Off"></span>
                                </label>
                                <span class="form-text text-muted">
                                    Do not print FXServer's output to the terminal. You will still be able to use the
                                    Live Console.
                                </span>
                            </div>
                        </div>

                        <div class="text-center mt-4">
                            <button class="btn btn-sm btn-primary" type="submit" id="frmFXServer-save" {{disableWrite}}>
                                <i class="icons cui-check"></i> Save FXServer Settings
                            </button>
                        </div>
                        <!-- /FXServer Card -->

                    </div>
                    <div class="tab-pane fade" id="nav-monitor" role="tabpanel" aria-labelledby="nav-monitor-tab">

                        <!-- Monitor Card -->
                        <div class="form-group row">
                            <label for="frmMonitor-schedule" class="col-sm-3 col-form-label">Scheduled Restarts</label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" id="frmMonitor-schedule" value="{{monitor.restarter.schedule}}"
                                    placeholder="05:00, 13:00" {{disableWrite}}>
                                <span class="form-text text-danger font-weight-boldx" id="frmMonitor-timezoneAlert"></span>
                                <span class="form-text text-muted">
                                    At which times of day to restart the server. Leave it blank to disable this feature. <br>
                                    The time MUST be in the 24-hour format with two digits for hours as well as
                                    minutes (<code>HH:MM</code>) and the times should be separated by commas. <br>
                                    <strong>Note:</strong> Make sure your schedule matches your server time and not your local time.
                                </span>
                            </div>
                        </div>
                        <div class="form-group row">
                            <label for="frmMonitor-conservative" class="col-sm-3 col-form-label">Conservative Mode</label>
                            <div class="col-sm-9">
                                <label class="switch switch-label switch-pill switch-success fix-pill-form">
                                    <input class="switch-input" type="checkbox" id="frmMonitor-conservative"
                                        checked disabled>
                                    <span class="switch-slider" data-checked="On" data-unchecked="Off"></span>
                                </label>
                                <span class="form-text text-muted">
                                    Try not to restart the server when it is still working (doesn't apply to partial crashes).
                                </span>
                            </div>
                        </div>
                        <div class="form-group row">
                            <label for="frmMonitor-detectPartial" class="col-sm-3 col-form-label">Detect Partial Crash</label>
                            <div class="col-sm-9">
                                <label class="switch switch-label switch-pill switch-success fix-pill-form">
                                    <input class="switch-input" type="checkbox" id="frmMonitor-detectPartial"
                                        checked disabled>
                                    <span class="switch-slider" data-checked="On" data-unchecked="Off"></span>
                                </label>
                                <span class="form-text text-muted">
                                    Detect when FXServer's HTTP endpoint dies and restart the server after 5 minutes. <br>
                                    On a partial crash, new players won't be able to connect and your server will not
                                    show in the server list even though players inside will still be able to play. <br>
                                    This feature is still in beta
                                </span>
                            </div>
                        </div>

                        <div class="text-center mt-4">
                            <button class="btn btn-sm btn-primary" type="submit" id="frmMonitor-save" {{disableWrite}}>
                                <i class="icons cui-check"></i> Save Monitor/Restarter Settings
                            </button>
                        </div>
                        <!-- /Monitor Card -->

                    </div>
                    <div class="tab-pane fade" id="nav-discord" role="tabpanel" aria-labelledby="nav-discord-tab">

                        <!-- Discord Card -->
                        <div class="form-group row">
                            <label for="frmDiscord-enabled" class="col-sm-3 col-form-label">Enable Bot</label>
                            <div class="col-sm-9">
                                <label class="switch switch-label switch-pill switch-success fix-pill-form">
                                    <input class="switch-input" type="checkbox" id="frmDiscord-enabled"
                                        {{discord.enabled}} {{disableWrite}}>
                                    <span class="switch-slider" data-checked="On" data-unchecked="Off"></span>
                                </label>
                                <span class="form-text text-muted">
                                    Enable Discord Integration.
                                </span>
                            </div>
                        </div>

                        <div class="form-group row">
                            <label for="frmDiscord-token" class="col-sm-3 col-form-label">Token <span
                                    class="text-danger">*</span></label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" id="frmDiscord-token" value="{{discord.token}}"
                                    maxlength="96" {{disableWrite}}>
                                <span class="form-text text-muted">
                                    To get a token and the bot to join your server, follow these two guides:
                                    <a href="https://discordjs.guide/preparations/setting-up-a-bot-application.html"
                                        target="_blank" rel="noopener noreferrer">Setting up a bot application</a> and
                                    <a href="https://discordjs.guide/preparations/adding-your-bot-to-servers.html">Adding
                                        your bot to servers</a>.
                                </span>
                            </div>
                        </div>

                        <div class="form-group row">
                            <label for="frmDiscord-announceChannel" class="col-sm-3 col-form-label">Announcements Channel ID</label>
                            <div class="col-sm-9">
                                <input type="number" class="form-control" id="frmDiscord-announceChannel"
                                    value="{{discord.announceChannel}}" {{disableWrite}}>
                                <span class="form-text text-muted">
                                    The ID of the channel to send Announcements (eg server restarts). <br>
                                    Leave it blank to disable this feature. <br>
                                    To get the channel ID, go to Discord's settings and
                                    <a href="https://support.discordapp.com/hc/article_attachments/115002742731/mceclip0.png"
                                    target="_blank" > enable developer mode</a>, then right-click on the channel name and select "Copy ID".
                                </span>
                            </div>
                        </div>

                        <div class="form-group row">
                            <label for="frmDiscord-statusCommand" class="col-sm-3 col-form-label">
                                Status Command
                                <span class="text-danger">*</span>
                            </label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" id="frmDiscord-statusCommand" value="{{discord.statusCommand}}"
                                    placeholder="/status" {{disableWrite}}>
                                <span class="form-text text-muted">
                                    The command that will trigger a status message from the bot.
                                </span>
                            </div>
                        </div>


                        <div class="text-center mt-4">
                            <button class="btn btn-sm btn-primary" type="submit" id="frmDiscord-save" {{disableWrite}}>
                                <i class="icons cui-check"></i> Save Discord Settings
                            </button>
                        </div>
                        <!-- /Discord Card -->

                    </div>
                </div>
            </div>


        </div>

    </div>
</div>


{{include("footer")/}}


<script>
    //============================================== General
    let serverTimezone = "{{serverTimezone}}";
    let browserTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
    if(serverTimezone !== browserTimezone){
        let msg = `Your timezone: <b>${browserTimezone}</b> <br>
            Server's timezone: <b>${serverTimezone}</b> <br>
            Make sure to adjust the times to match your expectations.`;
        $('#frmMonitor-timezoneAlert').html(msg);
    }


    //============================================== Global Settings
    $('#frmGlobal-save').click(function () {
        let data = {
            serverName: $('#frmGlobal-serverName').val().trim(),
            publicIP: $('#frmGlobal-publicIP').val().trim(),
            language: $('#frmGlobal-language').val(),
            verbose: $('#frmGlobal-verbose').is(':checked')
        }
        if (!data.serverName.length || !data.publicIP.length) {
            var notify = $.notify({ message: 'The fields with "*" are required.' }, { type: 'warning' });
            return;
        }
        var notify = $.notify({ message: '<p class="text-center">Saving...</p>' }, {});

        $.ajax({
            type: "POST",
            url: '/settings/save/global',
            timeout: 2000,
            data: data,
            dataType: 'json',
            success: function (data) {
                notify.update('progress', 0);
                notify.update('type', data.type);
                notify.update('message', data.message);
            },
            error: function (xmlhttprequest, textstatus, message) {
                notify.update('progress', 0);
                notify.update('type', 'danger');
                notify.update('message', message);
            }
        });
    });


    //============================================== FXServer Settings
    $('#frmFXServer-save').click(function () {
        let data = {
            buildPath: $('#frmFXServer-buildPath').val().trim(),
            basePath: $('#frmFXServer-basePath').val().trim(),
            cfgPath: $('#frmFXServer-cfgPath').val().trim(),
            onesync: $('#frmFXServer-onesync').is(':checked'),
            autostart: $('#frmFXServer-autostart').is(':checked'),
            quiet: $('#frmFXServer-quiet').is(':checked')
        }
        if (!data.buildPath.length || !data.basePath.length || !data.cfgPath.length) {
            var notify = $.notify({ message: 'The fields with "*" are required.' }, { type: 'warning' });
            return;
        }
        var notify = $.notify({ message: '<p class="text-center">Saving...</p>' }, {});

        $.ajax({
            type: "POST",
            url: '/settings/save/fxserver',
            timeout: 2000,
            data: data,
            dataType: 'json',
            success: function (data) {
                notify.update('progress', 0);
                notify.update('type', data.type);
                notify.update('message', data.message);
            },
            error: function (xmlhttprequest, textstatus, message) {
                notify.update('progress', 0);
                notify.update('type', 'danger');
                notify.update('message', message);
            }
        });
    });


    //============================================== Monitor Settings
    $('#frmMonitor-save').click(function () {
        let data = {
            schedule: $('#frmMonitor-schedule').val().trim()
        }
        var notify = $.notify({ message: '<p class="text-center">Saving...</p>' }, {});

        $.ajax({
            type: "POST",
            url: '/settings/save/monitor',
            timeout: 2000,
            data: data,
            dataType: 'json',
            success: function (data) {
                notify.update('progress', 0);
                notify.update('type', data.type);
                notify.update('message', data.message);
            },
            error: function (xmlhttprequest, textstatus, message) {
                notify.update('progress', 0);
                notify.update('type', 'danger');
                notify.update('message', message);
            }
        });
    });


    //============================================== Discord Settings
    $('#frmDiscord-save').click(function () {
        let data = {
            enabled: ($('#frmDiscord-enabled').is(':checked') === true),
            token: $('#frmDiscord-token').val().trim(),
            announceChannel: $('#frmDiscord-announceChannel').val().trim(),
            statusCommand: $('#frmDiscord-statusCommand').val().trim()
        };
        if (data.enabled && (!data.token.length || !data.statusCommand.length)) {
            var notify = $.notify({ message: 'The fields with "*" are required when the bot is enabled.' }, { type: 'warning' });
            return;
        }
        var notify = $.notify({ message: '<p class="text-center">Saving...</p>' }, {});

        $.ajax({
            type: "POST",
            url: '/settings/save/discord',
            timeout: 2000,
            data: data,
            dataType: 'json',
            success: function (data) {
                notify.update('progress', 0);
                notify.update('type', data.type);
                notify.update('message', data.message);
            },
            error: function (xmlhttprequest, textstatus, message) {
                notify.update('progress', 0);
                notify.update('type', 'danger');
                notify.update('message', message);
            }
        });
    });

</script>
